<UserControl x:Class="Bc3_WPF.Screens.TablaDePresupuestos"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Bc3_WPF"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
             xmlns:vms="clr-namespace:Bc3_WPF.Screens.Charts"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">

    <!-- Your ViewModel -->
    <UserControl.DataContext>
        <vms:Pie/>
    </UserControl.DataContext>

    <!-- Main Grid Layout -->
    <Grid>
        <!-- Define top-level Rows -->
        <Grid.RowDefinitions>
            <RowDefinition Height="auto"/>
            <!-- Title + Select File -->
            <RowDefinition Height="auto"/>
            <!-- Rectangles: Quantity & Concepts -->
            <RowDefinition Height="auto"/>
            <!-- Charts: Cartesian & Pie -->
            <RowDefinition Height="auto"/>
            <!-- Table + DB Selection -->
        </Grid.RowDefinitions>

        <!-- Define top-level Columns -->
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="5*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- ========== TITLE + SELECT FILE BUTTON (Row 0) ========== -->

        <!-- Title -->
        <TextBlock Name="Titulo" 
                   Grid.Row="0" Grid.Column="0"
                   Grid.ColumnSpan="2"
                   Text="🗃️  Explore BC3 Tool"
                   FontSize="20" 
                   FontWeight="Heavy"
                   VerticalAlignment="Center"
                   Padding="10"
                   Margin="30,0,0,0"/>

        <!-- Button Selección de archivo -->
        <Button Name="FileButton"
                Grid.Row="0" Grid.RowSpan="5"
                Grid.Column="0" Grid.ColumnSpan="3"
                Content="Select File"
                VerticalAlignment="Center"
                HorizontalAlignment="Center"
                FontSize="40"
                Margin="10"
                Click="LoadBC3"/>


        <!-- ========== RECTANGLES FOR QUANTITY & CONCEPTS (Row 1) ========== -->

        <!-- Wrap both rectangles in a StackPanel so they can sit side-by-side -->
        <StackPanel Grid.Row="1" Grid.Column="1"
                    Margin="100,0,0,0"
                    Orientation="Horizontal"
                    HorizontalAlignment="Center"
                    Visibility="Hidden"
                    Name="RectangleInfo">
            <!-- Quantity Panel -->
            <StackPanel Margin="20">
                <Rectangle x:Name="QuantityRectangle" 
                           Height="140" Width="250"
                           Stroke="DarkGray"
                           Fill="Black"
                           RadiusX="20" RadiusY="20"/>
                <TextBlock x:Name="QuantityTitle"
                           Text="Total Carbono"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Center"
                           Margin="0,-100,0,0"/>
                <TextBlock x:Name="Quantity"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Center"
                           Margin="0,-60,0,0"/>
            </StackPanel>

            <!-- Concepts Panel -->
            <StackPanel Margin="20">
                <Rectangle x:Name="ConceptRectangle"
                           Height="140" Width="300"
                           Stroke="DarkGray"
                           RadiusX="20" RadiusY="20"/>
                <TextBlock x:Name="ConceptTitle"
                           Text="Total Agua"
                           FontSize="20"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Margin="0,-100,0,0"/>
                <TextBlock x:Name="Concepts"
                           FontSize="20"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Margin="0,-60,0,0"/>
            </StackPanel>
        </StackPanel>


        <!-- ========== CHARTS (Row 2) ========== -->

        <!-- A grid to hold both charts side-by-side -->
        <Grid Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" 
              Visibility="Hidden" Name="ChartSection" HorizontalAlignment="Center"
              Margin="0,0,100,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="3*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Cartesian Chart & Rectangle -->
            <StackPanel Grid.Column="0" Grid.ColumnSpan="3" HorizontalAlignment="Right" Margin="0,0,20,0">
                <Rectangle x:Name="PieRectangle" 
                           Height="250" Width="680"
                           Stroke="DarkGray"
                           RadiusX="20" RadiusY="20"/>
                <lvc:CartesianChart x:Name="Chart"
                                    Height="250" Width="680"
                                    Margin="0,-250,0,0"/>
                <!-- Adjust margin if needed so chart overlays rectangle -->
            </StackPanel>

            <!-- Pie Chart & Rectangle -->
            <StackPanel Grid.Column="3" Grid.ColumnSpan="3" HorizontalAlignment="Left" Margin="0,0,0,0">
                <Rectangle x:Name="ChartRectangle"
                           Height="250" Width="400"
                           Stroke="DarkGray"
                           RadiusX="20" RadiusY="20"/>
                <lvc:PieChart x:Name="PieChart"
                              Height="250" Width="400"
                              Margin="0,-250,0,0"/>
                <!-- Adjust margin if needed so chart overlays rectangle -->
            </StackPanel>
        </Grid>


        <!-- ========== TABLE + DATABASE SELECTION (Row 3) ========== -->

        <!-- A grid to hold the table background rectangle, DB selection, and the DataGrid -->
        <Grid Grid.Row="2" Grid.RowSpan="4" 
              Grid.Column="1" Grid.ColumnSpan="2" 
              HorizontalAlignment="Center"
              Visibility="Hidden" 
              Margin="0,10,100,0" 
              x:Name="TableSection">
            <Grid.RowDefinitions>
                <RowDefinition Height="33"/>
                <RowDefinition Height="25"/>
                <RowDefinition Height="auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>

            <!-- Big rectangle behind the table area -->
            <Rectangle x:Name="TableRectangle"
                       Grid.RowSpan="3"
                       Grid.Column="0"
                       Grid.ColumnSpan="2"
                       Stroke="DarkGray"
                       RadiusX="20" RadiusY="20"
                       HorizontalAlignment="Stretch"
                       VerticalAlignment="Stretch"
                       Height="auto" Width="auto"
                       Panel.ZIndex="0"/>

            <!-- Medidores Label & ComboBox (Row 0) -->
            <TextBlock Grid.Row="0"
                       Grid.Column="1"
                       Text="Medidor"
                       FontSize="13"
                       FontWeight="Bold"
                       Margin="20,10,0,0"
                       HorizontalAlignment="Center"/>
            <ComboBox x:Name="SelectMedidor"
                      Grid.Row="0"
                      Grid.Column="1"
                      HorizontalAlignment="Center"
                      Margin="200,10,0,0"
                      Width="100"
                      SelectionChanged="handleChangeMedidor"
                      SelectedIndex="0">
            </ComboBox>

            <Button Grid.Row="0"
                    Grid.Column="0"
                    Content="Show Graphs"
                    FontSize="13"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Click="ShowGraphs"
                    x:Name="ToggleGraphs"/>
            <!-- Table Title (Row 1) -->
            <TextBlock x:Name="TitleTable"
                       Grid.Row="1"
                       Grid.Column="0"
                       Grid.ColumnSpan="12"
                       FontStyle="Italic"
                       FontWeight="ExtraBold"
                       FontSize="15"
                       Margin="20,5,0,0"
                       HorizontalAlignment="Left"/>

            <!-- The DataGrid (Row 2) -->
            <DataGrid x:Name="Tabla"
                      Grid.Row="2"
                      Grid.Column="0"
                      Grid.ColumnSpan="2"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      IsReadOnly="True"
                      Width="auto"
                      Height="auto"
                      Margin="20,5,20,10"
                      Visibility="Visible">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Id" Binding="{Binding Id}" Width="auto"/>
                    <DataGridTextColumn Header="Internal Id" Binding="{Binding InternalId}" Width="auto" />
                    <DataGridTextColumn Header="Description" Binding="{Binding name}" Width="auto"/>
                    <DataGridTextColumn Header="Category" Binding="{Binding category}" Width="auto" />
                    <DataGridTextColumn Header="" x:Name="TablaMedidor" Binding="{Binding display}" Width="auto" Visibility="Hidden"/>
                    <DataGridTextColumn Header="Quantity" Binding="{Binding quantity}" Width="auto"/>
                    <DataGridTemplateColumn Header="Options" Width="auto">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Button x:Name="buttonHijos" 
                                            Content="View Children"
                                            Click="handleHijos"
                                            Visibility="Visible"
                                            BorderThickness="0"
                                            Background="Transparent"
                                            Foreground="#0000EE"/>
                                    <Button x:Name="nullHijos"
                                            Content="Split Concept"
                                            Click="handleSplit"
                                            Visibility="Hidden"
                                            BorderThickness="0"
                                            Background="Transparent"
                                            Foreground="#0000EE"/>
                                    <TextBlock x:Name="Past"
                                               Visibility="Hidden"
                                               Text="Previous"/>
                                </Grid>
                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding hijos}" Value="{x:Null}">
                                        <Setter TargetName="buttonHijos" Property="Visibility" Value="Hidden"/>
                                        <Setter TargetName="nullHijos" Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding outdated}" Value="True">
                                        <Setter TargetName="buttonHijos" Property="Visibility" Value="Hidden"/>
                                        <Setter TargetName="nullHijos" Property="Visibility" Value="Hidden"/>
                                        <Setter TargetName="Past" Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding outdated}" Value="True">
                                <Setter Property="Background" Value="Red"/>
                                <Setter Property="Foreground" Value="White"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
            </DataGrid>


            <!-- ========== PAGINATOR + BACK & SAVE BUTTONS (Row 4) ========== -->

            <!-- A StackPanel for page controls and other buttons -->
            <StackPanel x:Name="Paginator"
            Grid.Row="3" Grid.ColumnSpan="2"
            Orientation="Horizontal"
            HorizontalAlignment="Center"
            VerticalAlignment="Bottom"
            Visibility="Hidden"
            Margin="100,0,0,0"
            Panel.ZIndex="1">
                <!-- Previous Page -->
                <Button x:Name="Previous"
            Content="◀️"
            Click="PreviousPage"
            Background="Transparent"
            BorderThickness="0"
            Visibility="Hidden">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="0">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Button.Template>
                </Button>

                <!-- Page Number -->
                <TextBlock x:Name="PageNumber"
               VerticalAlignment="Center"
               Margin="10"
               Visibility="Hidden"/>

                <!-- Next Page -->
                <Button x:Name="Next"
            Content="▶️"
            Click="NextPage"
            Background="Transparent"
            BorderThickness="0"
            Visibility="Hidden">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="0">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Button.Template>
                </Button>

                <!-- Boton de Historial -->
                <Button x:Name="BackButton"
            Content="🔙"
            Visibility="Hidden"
            Click="BackButtonClick"
            Background="Transparent"
            FontSize="25"
            BorderThickness="0"
            Panel.ZIndex="1"
            BorderBrush="Transparent"
            Margin="20,0,0,0"/>

                <!-- Boton Guardar -->
                <Button x:Name="SaveButton"
            Content="Descargar"
            Visibility="Hidden"
            Click="SaveButtonClick"
            Background="Transparent"
            FontSize="15"
            BorderThickness="1"
            Panel.ZIndex="1"
            FontWeight="Bold"
            Margin="20,0,0,0"
            Height="25"/>
            </StackPanel>
        </Grid>



        <!-- ========== POPUP DESENSAMBLADO (Row 5, but it can float anywhere) ========== -->

        <Popup x:Name="SplitPopUp"
               Visibility="Visible"
               Placement="Center"
               IsEnabled="True">
            <Grid>
                <DataGrid x:Name="SplitTable"
                          Height="auto" Width="auto"
                          MinHeight="200"
                          HorizontalAlignment="Stretch"
                          Margin="0,0,0,0"
                          VerticalAlignment="Top"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="False"
                          CanUserSortColumns="False">
                    <DataGrid.Columns>
                        <DataGridComboBoxColumn Header="Category"
                                SelectedItemBinding="{Binding Id}"
                                Width="auto"
                                x:Name="IdField"/>
                        <DataGridTextColumn Header="Description" Width="auto" Binding="{Binding name}"/>
                        <DataGridTextColumn Header="Quantity" Width="auto" Binding="{Binding quantity}"/>
                    </DataGrid.Columns>
                </DataGrid>

                <Button x:Name="CancelSplit"
                        Content="Cancel"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Bottom"
                        Click="CloseSplit"/>
                <Button x:Name="SaveSplit"
                        Content="Save"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Bottom"
                        Click="MakeSplit"/>
            </Grid>
        </Popup>


        <!-- ============ DOCUMENT TREE (Column 0 Row 2 - 4) ============ -->

        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Auto"
                      Grid.Column="0" 
                      VerticalAlignment="Top" 
                      Grid.Row="2" 
                      Grid.RowSpan="4"
                      HorizontalAlignment="Right"
                      Margin="0,0,-10,0">
            <TreeView Name="Tree" Height="500" Width="198"
                      Background="Transparent"
                      BorderThickness="0">
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding hijos}">
                        <Button x:Name="TreeButton" 
                            Content="{Binding Id}"
                            Click="TreeClick"
                            Visibility="Visible"
                            BorderThickness="0"
                            Background="Transparent"
                            Foreground="#0000EE"/>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>
        </ScrollViewer>
    </Grid>
</UserControl>
